<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Subcategory Manager</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" integrity="sha512-RvQxD1xX9Z+nq87shL6oI6+3w+OkMDWimk3L0m3vT/cslS+9f5TjL44z4Qjwhh69f7gD8mKjIfd1z+7klXJpHg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
      /* Your subcategory.css integrated */
      .navbar {
        background-color: #1DA1F2;
        padding: 10px 20px;
        color: white;
        position: fixed;
        width: 100%;
        top: 0;
        z-index: 1000;
      }

      .nav-inner {
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .brand {
        display: flex;
        align-items: center;
      }

      .logo svg {
        margin-right: 10px;
      }

      .brand-name {
        font-size: 18px;
        font-weight: bold;
      }

      .nav-actions {
        display: flex;
        align-items: center;
      }

      .dashboard-pill {
        display: flex;
        align-items: center;
        color: white;
        text-decoration: none;
        margin-right: 20px;
      }

      .dashboard-pill svg {
        margin-right: 5px;
      }

      .profile {
        position: relative;
      }

      .profile-trigger img {
        cursor: pointer;
        width: 34px;
        height: 34px;
        border-radius: 50%;
      }

      .profile-dropdown {
        display: none;
        position: absolute;
        right: 0;
        top: 100%;
        background: white;
        border: 1px solid #ddd;
        border-radius: 4px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        min-width: 150px;
        z-index: 1000;
      }

      .profile-dropdown ul {
        list-style: none;
        padding: 0;
        margin: 0;
      }

      .profile-dropdown li a {
        display: block;
        padding: 10px;
        color: #333;
        text-decoration: none;
      }

      .profile-dropdown li a:hover {
        background-color: #f5f5f5;
      }

      /* Main Container Styles */
      .container {
        margin-top: 80px; /* Increased to clear fixed navbar */
        padding: 20px;
      }

      /* Subcategory Banner */
      .subcategory-banner {
        background: linear-gradient(90deg, #007bff, #6f42c1);
        color: white;
        padding: 40px 20px;
        text-align: center;
        border-radius: 12px;
        margin-bottom: 25px;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
      }

      .subcategory-content {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 8px;
      }

      .subcategory-title {
        display: flex;
        align-items: center;
        gap: 10px;
        justify-content: center;
      }

      .subcategory-icon svg {
        color: white;
      }

      .subcategory-banner h1 {
        font-size: 28px;
        font-weight: 700;
        margin: 0;
      }

      .subcategory-banner p {
        font-size: 16px;
        opacity: 0.9;
        margin: 0;
      }

      /* Stats Cards */
      .stats-container {
        display: flex;
        justify-content: space-between;
        height: 30vh;
      }

      .card {
        background: #FFFFFF;
        border-radius: 8px;
        padding: 15px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        width: 48%;
        text-align: center;
        margin-bottom: 10vh;
      }

      .stats-card {
        text-align: left;
        padding: 15px;
        max-width: 260px;
        border-radius: 10px;
        background: #fff;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
        margin-bottom: 10vh;
      }

      .stats-card h3 {
        font-size: 16px;
        font-weight: 600;
        color: #007bff;
        display: flex;
        align-items: center;
        gap: 6px;
        margin-bottom: 14px;
      }

      .total-box {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        background: linear-gradient(90deg, #007bff, #6f42c1);
        color: white;
        padding: 6px 14px;
        border-radius: 50px;
        font-weight: 600;
        font-size: 14px;
        margin-bottom: 14px;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
      }

      .total-box svg {
        width: 16px;
        height: 16px;
      }

      .buttons {
        display: flex;
        gap: 8px;
        justify-content: center;
      }

      .btn {
        padding: 6px 12px;
        font-size: 14px;
        border-radius: 6px;
        border: none;
        cursor: pointer;
      }

      .btn-import {
        background-color: #28a745;
        color: white;
      }

      .btn-export {
        background-color: #007bff;
        color: white;
      }

      /* Search Container */
      .search-stats-wrapper {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-top: 5px;
        margin-bottom: 20px;
        gap: 20px;
      }

      .search-container {
        margin-top: 20px;
        background-color: #FFFFFF;
        padding: 10px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        width: 65%;
        max-width: 900px;
        height: 20vh;
      }

      .search {
        padding: 20px;
        color: #1DA1F2;
        font-size: 18px;
        font-weight: bold;
        margin-right: 10px;
        display: inline-block;
      }

      .search-bar {
        display: flex;
        align-items: center;
        width: 100%;
      }

      .search-bar svg {
        margin-right: 10px;
      }

      .search-bar input {
        flex: 1;
        padding: 8px;
        border: 1px solid #CED4DA;
        border-radius: 4px;
        font-size: 14px;
      }

      /* Filter Sort Container */
      .filter-sort-container {
        display: flex;
        flex-direction: column;
        margin-bottom: 20px;
        background: #fff;
        padding: 10px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      .filter-sort-header {
        display: flex;
        align-items: center;
        gap: 5px;
        margin-bottom: 10px;
      }

      .filter-sort-label {
        font-weight: bold;
        color: #1DA1F2;
      }

      .filter-sort-content {
        display: flex;
        align-items: center;
        justify-content: flex-end;
      }

      .filter-sort-options {
        display: flex;
        gap: 10px;
        margin-right: 600px;
      }

      .pill {
        padding: 8px 12px;
        border: 1px solid #CED4DA;
        border-radius: 20px;
        background: #fff;
        font-size: 14px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 5px;
      }

      .category-select,
      .sort-select {
        appearance: none;
        border: 1px solid #CED4DA;
        padding: 8px 12px;
        border-radius: 20px;
        background: none;
        font-size: 14px;
        width: 150px;
      }

      .category-select:focus,
      .sort-select:focus {
        outline: none;
        border-color: #1DA1F2;
      }

      .actions {
        display: flex;
        gap: 10px;
      }

      .btn.apply {
        background-color: #A461D8;
        color: white;
        padding: 8px 15px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 5px;
      }

      .btn.add-new-btn {
        background-color: #6f42c1;
        color: white;
        padding: 8px 19px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 5px;
      }

      /* Table */
      .category-table {
        width: 100%;
        border-collapse: collapse;
        background: #FFFFFF;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      .category-table th,
      .category-table td {
        padding: 10px;
        text-align: left;
        border-bottom: 1px solid #E1E8ED;
      }

      .category-table th {
        background-color: #F5F8FA;
        color: #657786;
      }

      .category-table td img {
        width: 50px;
        height: 50px;
        object-fit: cover;
      }

      .category-table .actions button {
        padding: 5px 10px;
        margin-right: 5px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
      }

      .edit-subcategory,
      .delete-subcategory {
        padding: 5px 10px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        margin-right: 5px;
      }

      .edit-subcategory {
        background-color: #1e88e5;
        color: white;
      }

      .delete-subcategory {
        background-color: #ff4444;
        color: white;
      }

      /* Popup Styles */
      .profile-popup {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        align-items: center;
        justify-content: center;
        z-index: 1000;
      }

      .popup-inner {
        background: white;
        padding: 20px;
        border-radius: 8px;
        width: 90%; /* Adjusted for mobile compatibility */
        max-width: 400px;
        position: relative;
      }

      .popup-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
      }

      .close-btn {
        background: none;
        border: none;
        font-size: 24px;
        cursor: pointer;
      }

      .image-container {
        text-align: center;
        margin-bottom: 20px;
      }

      .image-container img {
        width: 150px;
        height: 150px;
        object-fit: cover;
      }

      .image-btn {
        margin-top: 10px;
        padding: 5px 10px;
        background-color: #1DA1F2;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
      }

      .ecommerce-form .form-group {
        margin-bottom: 1px;
      }

      .ecommerce-form label {
        display: block;
        font-size: 14px;
        margin-bottom: 5px;
      }

      .ecommerce-form input,
      .ecommerce-form select {
        width: 100%;
        padding: 8px;
        border: 1px solid #CED4DA;
        border-radius: 4px;
      }

      .form-actions {
        display: flex;
        gap: 10px;
      }

      .save-btn {
        background-color: #1DA1F2;
        color: white;
        padding: 8px 15px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
      }

      .cancel-btn {
        background-color: #E1E8ED;
        color: #1DA1F2;
        padding: 8px 15px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
      }

      /* Modal Styles */
      .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 80%;
        background: rgba(0, 0, 0, 0.5);
      }

      .modal-content {
        background: #fff;
        margin: 5% auto;
        padding: 20px 24px;
        width: 420px;
        border-radius: 10px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        position: relative;
      }

      .modal-content h2 {
        margin: 0 0 15px;
        font-size: 18px;
        color: #333;
      }

      .modal-content label {
        font-weight: 600;
        display: block;
        margin-bottom: 6px;
      }

      .modal-content input[type="file"] {
        display: block;
        width: 100%;
        padding: 8px;
        border: 2px solid #ddd;
        border-radius: 6px;
        margin-bottom: 8px;
      }

      .hint {
        font-size: 12px;
        color: #666;
        margin-bottom: 12px;
      }

      .hint code {
        background: #f1f1f1;
        padding: 2px 6px;
        border-radius: 4px;
      }

      .checkbox-row {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 10px;
      }

      .checkbox-row input[type="checkbox"] {
        width: 16px;
        height: 16px;
        margin: 0;
        cursor: pointer;
        accent-color: #1DA1F2;
      }

      .checkbox-row label {
        font-size: 14px;
        color: #444;
        font-weight: 500;
        margin: 0;
      }

      .warning {
        background: #fff3cd;
        border: 1px solid #ffeeba;
        padding: 10px;
        border-radius: 6px;
        font-size: 13px;
        color: #856404;
        margin-bottom: 16px;
      }

      .modal-actions {
        display: flex;
        justify-content: flex-end;
        gap: 10px;
      }

      .btn {
        padding: 8px 14px;
        border-radius: 6px;
        border: none;
        cursor: pointer;
        font-weight: 600;
      }

      .btn-cancel {
        background: #e0e0e0;
      }

      .btn-blue {
        background: #007bff;
        color: white;
      }

      .btn-blue:hover {
        background: #0056b3;
      }

      .close {
        position: absolute;
        right: 16px;
        top: 10px;
        font-size: 22px;
        font-weight: bold;
        cursor: pointer;
      }

      #csvOptions {
        width: 5px;
        padding-left: 2px;
      }

      /* Footer */
      .footer {
        text-align: center;
        padding: 10px;
        color: #657786;
        margin-top: 20px;
      }

      /* Responsive Design */
      @media (max-width: 768px) {
        .stats-container {
          flex-direction: column;
          gap: 15px;
        }

        .card {
          width: 100%;
        }

        .search-container {
          flex-direction: column;
          gap: 15px;
          width: 100%;
          height: auto;
        }

        .filter-sort-container {
          flex-direction: column;
          gap: 15px;
        }

        .filter-sort-content {
          flex-direction: column;
          align-items: stretch;
        }

        .filter-sort-options {
          flex-direction: column;
          margin-right: 0;
          width: 100%;
        }

        .category-select,
        .sort-select {
          width: 100%;
          max-width: none;
        }

        .actions {
          flex-direction: column;
          width: 100%;
        }

        .actions .btn {
          width: 100%;
          margin: 5px 0;
        }

        .popup-inner {
          width: 90%;
          max-width: none;
        }

        .image-container img {
          width: 120px;
          height: 120px;
        }

        .ecommerce-form input,
        .ecommerce-form select {
          padding: 10px;
          font-size: 16px;
        }

        .form-actions {
          flex-direction: column;
        }

        .form-actions button {
          width: 100%;
          margin: 5px 0;
          padding: 12px;
        }
      }
    </style>
  </head>
  <body>
    <!-- NAVBAR -->
    <header class="navbar">
      <div class="nav-inner">
        <div class="brand">
          <div class="logo">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="28"
              height="28"
              fill="white"
              class="bi bi-check2-square"
              viewBox="0 0 16 16"
            >
              <path
                d="M3 14.5A1.5 1.5 0 0 1 1.5 13V3A1.5 1.5 0 0 1 3 1.5h8a.5.5 0 0 1 0 1H3a.5.5 0 0 0-.5.5v10a.5.5 0 0 0 .5.5h10a.5.5 0 0 0 .5-.5V8a.5.5 0 0 1 1 0v5a1.5 1.5 0 0 1-1.5 1.5z"
              />
              <path
                d="m8.354 10.354 7-7a.5.5 0 0 0-.708-.708L8 9.293 5.354 6.646a.5.5 0 1 0-.708.708l3 3a.5.5 0 0 0 .708 0"
              />
            </svg>
          </div>
          <span class="brand-name">TaskPro</span>
        </div>
        <div class="nav-actions">
          <a href="dashboard.html" class="dashboard-pill">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="18"
              height="18"
              fill="white"
              class="bi bi-house"
              viewBox="0 0 16 16"
            >
              <path
                d="M8.707 1.5a1 1 0 0 0-1.414 0L.646 8.146a.5.5 0 0 0 .708.708L2 8.207V13.5A1.5 1.5 0 0 0 3.5 15h9a1.5 1.5 0 0 0 1.5-1.5V8.207l.646.647a.5.5 0 0 0 .708-.708L13 5.793V2.5a.5.5 0 0 0-.5-.5h-1a.5.5 0 0 0-.5.5v1.293zM13 7.207V13.5a.5.5 0 0 1-.5.5h-9a.5.5 0 0 1-.5-.5V7.207l5-5z"
              />
            </svg>
            <span class="dashboard-text">Dashboard</span>
          </a>
          <div class="profile" id="profile">
            <div id="profileIcon" class="profile-trigger">
              <img
                src="download.jpeg"
                alt="Profile"
                style="width: 34px; height: 34px; border-radius: 50%"
              />
            </div>
            <div id="profileDropdown" class="profile-dropdown">
              <ul>
                <li><a href="#" id="editProfileLink">Edit</a></li>
                <li><a href="#" id="settingsLink">Settings</a></li>
                <li><a href="#" id="logoutLink">Logout</a></li>
              </ul>
            </div>
          </div>
        </div>
      </div>
    </header>

    <!-- Subcategory Manager Content -->
    <main class="container">
      <div class="subcategory-banner">
        <div class="subcategory-content">
          <div class="subcategory-title">
            <div class="subcategory-icon">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="34"
                height="34"
                fill="white"
                viewBox="0 0 24 24"
              >
                <path
                  d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"
                  stroke="currentColor"
                  stroke-width="2"
                  fill="none"
                />
              </svg>
            </div>
            <h1>Manage Subcategories</h1>
          </div>
          <p>Organize your products into categories and subcategories</p>
        </div>
      </div>
      <div class="search-stats-wrapper">
        <div class="search-container">
          <div class="search-bar">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-search" viewBox="0 0 16 16">
              <path d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001q.044.06.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1 1 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0"/>
            </svg>
            <span class="search">Search Subcategories</span>
            <input
              type="text"
              id="searchInput"
              placeholder="Search by name, category, or description..."
            />
          </div>
        </div>
        <div class="stats-container">
          <div class="card">
            <h3>Statistics</h3>
            <div class="total-box" id="totalSubcategories">Total: 0</div>
            <div class="buttons">
              <button class="btn btn-import">
                <i class="fas fa-upload"></i> Import
              </button>
              <button class="btn btn-export">
                <i class="fas fa-download"></i> Export
              </button>
              <button id="resetStorageBtn" style="background: #ff6b6b; color: white; margin-top: 5px; display: none;">Reset Storage</button>
            </div>
          </div>
        </div>
      </div>
      <div class="filter-sort-container">
        <div class="filter-sort-header">
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" class="bi bi-funnel" viewBox="0 0 16 16">
            <path d="M1.5 1.5A.5.5 0 0 1 2 1h12a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-.128.334L10 8.692V13.5a.5.5 0 0 1-.342.474l-3 1A.5.5 0 0 1 6 14.5V8.692L1.628 3.834A.5.5 0 0 1 1.5 3.5zm1 .5v1.308l4.372 4.858A.5.5 0 0 1 7 8.5v5.306l2-.666V8.5a.5.5 0 0 1 .128-.334L13.5 3.308V2z"/>
          </svg>
          <span class="filter-sort-label">Filter & Sort</span>
        </div>
        <div class="filter-sort-content">
          <div class="filter-sort-options">
            <select class="pill category-select" id="categorySelect" style="border: 1px solid #CED4DA;">
              <option value="all">Category: All Categories</option>
              <!-- Categories will be populated dynamically -->
            </select>
            <select class="pill sort-select" id="sortSelect" style="border: 1px solid #CED4DA;">
              <option value="default">Sort by: Default</option>
              <option value="name-asc">Name (A-Z)</option>
              <option value="name-desc">Name (Z-A)</option>
              <option value="price-asc">Price (Low to High)</option>
              <option value="price-desc">Price (High to Low)</option>
              <option value="newest">Newest First</option>
              <option value="oldest">Oldest First</option>
            </select>
          </div>
          <div class="actions">
            <button class="btn apply" id="applyFiltersBtn">✔ Apply</button>
            <button id="addNewSubBtnFilter" class="btn add-new-btn">➕ Add New</button>
          </div>
        </div>
      </div>
      
      <table class="category-table">
        <thead>
          <tr>
            <th>ID</th>
            <th>IMAGE</th>
            <th>CATEGORY</th>
            <th>SUBCATEGORY</th>
            <th>PRODUCT NAME</th>
            <th>PRICE</th>
            <th>QUANTITY</th>
            <th>DESCRIPTION</th>
            <th>ACTIONS</th>
          </tr>
        </thead>
        <tbody id="subcategoryTableBody">
          <!-- Subcategories will be inserted here -->
        </tbody>
      </table>
    </main>

    <!-- Add/Edit Subcategory Popup -->
    <div class="profile-popup" id="subcategoryPopup">
      <div class="popup-inner">
        <div class="popup-header">
          <h2 id="popupTitle">Add Subcategory</h2>
          <button class="close-btn" id="closePopupBtn">&times;</button>
        </div>
        <div class="image-container">
          <img
            id="subcategoryImg"
            alt="Subcategory Image"
            style="width: 150px; height: 150px; object-fit: cover"
          />
          <input
            type="file"
            id="subcategoryPhotoInput"
            accept="image/*"
            style="display: none"
          />
          <button id="changeSubcategoryPhoto" class="image-btn">
            Change Image
          </button>
        </div>
        <form id="subcategoryForm" class="ecommerce-form">
          <div class="form-group">
            <label>Category</label>
            <select id="subcategoryCategory" required>
              <!-- Categories will be populated dynamically -->
            </select>
          </div>
          <div class="form-group">
            <label>Subcategory</label>
            <input
              type="text"
              id="subcategoryName"
              required
              placeholder="e.g., Table Fan"
            />
          </div>
          <div class="form-group">
            <label>Product Name</label>
            <input
              type="text"
              id="productName"
              required
              placeholder="e.g., Premium Table Fan"
            />
          </div>
          <div class="form-group">
            <label>Price ($)</label>
            <input
              type="number"
              id="price"
              step="0.01"
              required
              placeholder="e.g., 49.99"
            />
          </div>
          <div class="form-group">
            <label>Quantity</label>
            <input
              type="number"
              id="quantity"
              required
              placeholder="e.g., 50"
            />
          </div>
          <div class="form-group">
            <label>Description</label>
            <input
              type="text"
              id="subcategoryDesc"
              required
              placeholder="e.g., High-quality table fan"
            />
          </div>
          <div class="form-actions">
            <button type="submit" class="save-btn">Save</button>
            <button type="button" class="cancel-btn">Cancel</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Edit Profile Popup -->
    <div class="profile-popup" id="profilePopup">
      <div class="popup-inner">
        <div class="popup-header">
          <h2>Edit Profile</h2>
          <button class="close-btn" id="closeProfilePopupBtn">&times;</button>
        </div>
        <div class="image-container">
          <img id="profileImg" alt="Profile" />
          <input
            type="file"
            id="photoInput"
            accept="image/*"
            style="display: none"
          />
          <button id="changePhoto" class="image-btn">Change Photo</button>
        </div>
        <form id="profileForm" class="ecommerce-form">
          <div class="form-group">
            <label>Username</label>
            <input type="text" id="username" value="owner" />
          </div>
          <div class="form-group">
            <label>Email</label>
            <input type="email" id="email" value="owner@signaltone.com" />
          </div>
          <div class="form-actions">
            <button type="submit" class="save-btn">Save Changes</button>
            <button type="button" class="cancel-btn">Cancel</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Import Modal -->
    <div id="importModal" class="modal">
      <div class="modal-content">
        <span class="close">&times;</span>
        <h2>📂 Import Subcategories from CSV</h2>
        <label for="csvFile">CSV File</label>
        <input type="file" id="csvFile" accept=".csv" />
        <p class="hint">
          CSV format: <code>category,subcategory,productName,price,description,image,quantity,createdAt</code> (image, quantity, and createdAt optional).
          <a href="#" id="downloadTemplate">Download template</a>
        </p>
        <div class="checkbox-row">
          <input type="checkbox" id="containsHeaders" checked />
          <label for="containsHeaders">First row contains headers</label>
        </div>
        <div class="warning">
          ⚠️ Existing subcategories with the same product name and category will be updated.<br />
          New subcategories will be added.
        </div>
        <div class="modal-actions">
          <button class="btn btn-cancel">Cancel</button>
          <button class="btn btn-blue" id="importSubcategoriesBtn">⬆ Import Subcategories</button>
        </div>
      </div>
    </div>

    <!-- Export Modal -->
    <div id="exportModal" class="modal">
      <div class="modal-content">
        <span class="close">&times;</span>
        <h2>Export subcategories to CSV</h2>
        <p>Click below to export all subcategories as a CSV file.</p>
        <button class="btn btn-blue" id="downloadCsvBtn">Download CSV</button>
      </div>
    </div>

    <footer class="footer">
      <small>©️ 2025 TaskPro — Dashboard prototype (Last updated: 10:18 PM IST, Thursday, September 25, 2025)</small>
    </footer>

    <script>
      // Profile functionality
      const savedUsername = localStorage.getItem("username") || "owner";
      const savedEmail = localStorage.getItem("email") || "owner@signaltone.com";
      const savedProfileImg = localStorage.getItem("profileImg") || "download.jpeg";

      document.getElementById("username").value = savedUsername;
      document.getElementById("email").value = savedEmail;
      const profileIcon = document.getElementById("profileIcon");
      const profileImg = document.getElementById("profileImg");
      const profileTrigger = document.querySelector(".profile-trigger");
      const profilePopup = document.getElementById("profilePopup");
      const profileForm = document.getElementById("profileForm");
      const usernameInput = document.getElementById("username");
      const emailInput = document.getElementById("email");
      const photoInput = document.getElementById("photoInput");
      const changePhotoBtn = document.getElementById("changePhoto");
      const closeProfilePopupBtn = document.getElementById("closeProfilePopupBtn");
      const profileDropdown = document.getElementById("profileDropdown");
      const editProfileLink = document.getElementById("editProfileLink");
      const settingsLink = document.getElementById("settingsLink");
      const logoutLink = document.getElementById("logoutLink");

      profileImg.src = savedProfileImg;
      profileIcon.innerHTML = `<img src="${savedProfileImg}" alt="Profile" style="width: 34px; height: 34px; border-radius: 50%;">`;

      profileTrigger.addEventListener("click", (e) => {
        e.preventDefault();
        profileDropdown.style.display = profileDropdown.style.display === "block" ? "none" : "block";
      });

      editProfileLink.addEventListener("click", (e) => {
        e.preventDefault();
        profileDropdown.style.display = "none";
        profilePopup.style.display = "flex";
      });

      settingsLink.addEventListener("click", (e) => {
        e.preventDefault();
        profileDropdown.style.display = "none";
        alert("Settings page is not implemented yet.");
      });

      logoutLink.addEventListener("click", (e) => {
        e.preventDefault();
        profileDropdown.style.display = "none";
        if (confirm("Are you sure you want to logout?")) {
          localStorage.removeItem("username");
          localStorage.removeItem("email");
          localStorage.removeItem("profileImg");
          window.location.href = "index.html";
        }
      });

      changePhotoBtn.addEventListener("click", () => {
        photoInput.click();
      });

      photoInput.addEventListener("change", (e) => {
        const file = e.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = (event) => {
            profileImg.src = event.target.result;
            profileIcon.innerHTML = `<img src="${event.target.result}" alt="Profile" style="width: 34px; height: 34px; border-radius: 50%;">`;
          };
          reader.readAsDataURL(file);
        }
      });

      profileForm.addEventListener("submit", (e) => {
        e.preventDefault();
        const username = usernameInput.value;
        const email = emailInput.value;
        const profileImgSrc = profileImg.src;
        localStorage.setItem("username", username);
        localStorage.setItem("email", email);
        localStorage.setItem("profileImg", profileImgSrc);
        profileIcon.innerHTML = `<img src="${profileImgSrc}" alt="Profile" style="width: 34px; height: 34px; border-radius: 50%;">`;
        profilePopup.style.display = "none";
      });

      document.querySelector("#profilePopup .cancel-btn").addEventListener("click", () => {
        profilePopup.style.display = "none";
        usernameInput.value = localStorage.getItem("username") || "owner";
        emailInput.value = localStorage.getItem("email") || "owner@signaltone.com";
        profileImg.src = localStorage.getItem("profileImg") || "https://via.placeholder.com/100";
        profileIcon.innerHTML = `<img src="${profileImg.src}" alt="Profile" style="width: 34px; height: 34px; border-radius: 50%;">`;
      });

      closeProfilePopupBtn.addEventListener("click", () => {
        profilePopup.style.display = "none";
      });

      // Subcategory functionality
      let categories = JSON.parse(localStorage.getItem("categories")) || [];
      let subcategories = JSON.parse(localStorage.getItem("subcategories")) || [];

      // Validate and normalize createdAt for subcategories
      subcategories = subcategories.map(sub => {
        const createdAt = sub.createdAt && !isNaN(new Date(sub.createdAt)) 
          ? sub.createdAt 
          : new Date().toISOString();
        return { ...sub, createdAt };
      });
      localStorage.setItem("subcategories", JSON.stringify(subcategories));

      const subcategoryTableBody = document.getElementById("subcategoryTableBody");
      const totalSubcategories = document.getElementById("totalSubcategories");
      const addNewSubBtn = document.getElementById("addNewSubBtnFilter");
      const subcategoryPopup = document.getElementById("subcategoryPopup");
      const popupTitle = document.getElementById("popupTitle");
      const subcategoryForm = document.getElementById("subcategoryForm");
      const subcategoryCategorySelect = document.getElementById("subcategoryCategory");
      const subcategoryNameInput = document.getElementById("subcategoryName");
      const productNameInput = document.getElementById("productName");
      const priceInput = document.getElementById("price");
      const quantityInput = document.getElementById("quantity");
      const subcategoryDescInput = document.getElementById("subcategoryDesc");
      const subcategoryImg = document.getElementById("subcategoryImg");
      const subcategoryPhotoInput = document.getElementById("subcategoryPhotoInput");
      const changeSubcategoryPhotoBtn = document.getElementById("changeSubcategoryPhoto");
      const searchInput = document.getElementById("searchInput");
      const sortSelect = document.getElementById("sortSelect");
      const applyFiltersBtn = document.getElementById("applyFiltersBtn");
      const closePopupBtn = document.getElementById("closePopupBtn");
      const categorySelect = document.getElementById("categorySelect");
      const resetStorageBtn = document.getElementById("resetStorageBtn");
      let editingIndex = -1;

      const defaultImage = "https://images.unsplash.com/photo-1600585152280-be6161a56a0c?auto=format&fit=crop&w=150&q=80";

      // Function to deduplicate categories by name (case-insensitive)
      function deduplicateCategories(cats) {
        const seen = new Map();
        cats.forEach((cat) => {
          const nameLower = (cat.name || "").trim().toLowerCase();
          if (nameLower && !seen.has(nameLower)) {
            seen.set(nameLower, { ...cat, name: cat.name.trim() });
          } else if (nameLower) {
            seen.set(nameLower, { ...cat, name: cat.name.trim() });
          }
        });
        return Array.from(seen.values());
      }

      // Initialize categories with deduplication
      categories = deduplicateCategories(categories);

      // Function to populate category dropdowns
      function populateCategoryDropdowns() {
        subcategoryCategorySelect.innerHTML = "";
        categorySelect.innerHTML = '<option value="all">Category: All Categories</option>';

        const uniqueCategories = deduplicateCategories(categories);
        console.log("Populating dropdowns with categories:", uniqueCategories);

        uniqueCategories.forEach((cat) => {
          const option1 = document.createElement("option");
          option1.value = (cat.name || "").trim().toLowerCase();
          option1.textContent = cat.name || "";
          subcategoryCategorySelect.appendChild(option1);

          const option2 = document.createElement("option");
          option2.value = (cat.name || "").trim().toLowerCase();
          option2.textContent = cat.name || "";
          categorySelect.appendChild(option2);
        });

        subcategoryImg.src =
          uniqueCategories.find((cat) => (cat.name || "").trim().toLowerCase() === (subcategoryCategorySelect.value || "").trim().toLowerCase())?.image ||
          defaultImage;
      }

      // Initialize category dropdowns
      populateCategoryDropdowns();

      // Listen for changes to categories in localStorage
      window.addEventListener("storage", (e) => {
        if (e.key === "categories") {
          categories = JSON.parse(e.newValue) || [];
          categories = deduplicateCategories(categories);
          console.log("Categories updated:", categories);
          populateCategoryDropdowns();
          renderSubcategories(searchInput.value, categorySelect.value);
        }
      });

      function renderSubcategories(searchFilter = "", filterCategory = "all") {
        subcategoryTableBody.innerHTML = "";
        console.log("Filtering with:", { searchFilter, filterCategory });
        let filteredSubcategories = subcategories.filter((sub) => {
          const matchesSearch =
            (sub.productName || "").toLowerCase().includes(searchFilter.toLowerCase()) ||
            ((sub.category || "").trim().toLowerCase().includes(searchFilter.toLowerCase())) ||
            (sub.desc || "").toLowerCase().includes(searchFilter.toLowerCase());
          const matchesCategory = filterCategory === "all" || 
            ((sub.category || "").trim().toLowerCase() === (filterCategory || "").trim().toLowerCase());
          console.log("Subcategory:", sub.category, "Matches category:", matchesCategory);
          return matchesSearch && matchesCategory;
        });

        // Apply sorting
        console.log("Sorting subcategories by:", sortSelect.value);
        console.log("Before sorting:", filteredSubcategories.map(sub => ({ productName: sub.productName, createdAt: sub.createdAt })));
        switch (sortSelect.value) {
          case "name-asc":
            filteredSubcategories.sort((a, b) => 
              (a.productName || "").localeCompare(b.productName || ""));
            break;
          case "name-desc":
            filteredSubcategories.sort((a, b) => 
              (b.productName || "").localeCompare(a.productName || ""));
            break;
          case "price-asc":
            filteredSubcategories.sort((a, b) => 
              (a.price || 0) - (b.price || 0));
            break;
          case "price-desc":
            filteredSubcategories.sort((a, b) => 
              (b.price || 0) - (a.price || 0));
            break;
          case "newest":
            filteredSubcategories.sort((a, b) => {
              const dateA = new Date(a.createdAt || "1970-01-01T00:00:00Z");
              const dateB = new Date(b.createdAt || "1970-01-01T00:00:00Z");
              if (isNaN(dateA)) console.error("Invalid dateA:", a.createdAt);
              if (isNaN(dateB)) console.error("Invalid dateB:", b.createdAt);
              return dateB - dateA;
            });
            break;
          case "oldest":
            filteredSubcategories.sort((a, b) => {
              const dateA = new Date(a.createdAt || "1970-01-01T00:00:00Z");
              const dateB = new Date(b.createdAt || "1970-01-01T00:00:00Z");
              if (isNaN(dateA)) console.error("Invalid dateA:", a.createdAt);
              if (isNaN(dateB)) console.error("Invalid dateB:", b.createdAt);
              return dateA - dateB;
            });
            break;
          default:
            break;
        }
        console.log("After sorting:", filteredSubcategories.map(sub => ({ productName: sub.productName, createdAt: sub.createdAt })));

        filteredSubcategories.forEach((sub, index) => {
          const row = document.createElement("tr");
          row.innerHTML = `
            <td>${index + 1}</td>
            <td><img src="${sub.image || defaultImage}" alt="${sub.productName || ''}" style="width: 50px; height: 50px; object-fit: cover;"></td>
            <td>${sub.category || ''}</td>
            <td>${sub.subcategory || ''}</td>
            <td>${sub.productName || ''}</td>
            <td>$${sub.price ? sub.price.toFixed(2) : '0.00'}</td>
            <td>${sub.quantity || 0}</td>
            <td>${sub.desc || ''}</td>
            <td>
              <button class="edit-subcategory" data-index="${index}">Edit</button>
              <button class="delete-subcategory" data-index="${index}">Delete</button>
            </td>
          `;
          subcategoryTableBody.appendChild(row);
        });
        totalSubcategories.textContent = `Total: ${filteredSubcategories.length}`;
      }

      renderSubcategories();

      addNewSubBtn.addEventListener("click", () => {
        if (!addNewSubBtn) {
          console.error("Add New button not found!");
          return;
        }
        popupTitle.textContent = "Add Subcategory";
        const uniqueCategories = deduplicateCategories(categories);
        subcategoryCategorySelect.value = uniqueCategories[0]?.name.trim().toLowerCase() || "";
        subcategoryNameInput.value = "";
        productNameInput.value = "";
        priceInput.value = "";
        quantityInput.value = "";
        subcategoryDescInput.value = "";
        subcategoryImg.src =
          uniqueCategories.find((cat) => (cat.name || "").trim().toLowerCase() === (subcategoryCategorySelect.value || "").trim().toLowerCase())?.image ||
          defaultImage;
        editingIndex = -1;
        subcategoryPopup.style.display = "flex";
      });

      subcategoryCategorySelect.addEventListener("change", () => {
        const uniqueCategories = deduplicateCategories(categories);
        subcategoryImg.src =
          uniqueCategories.find((cat) => (cat.name || "").trim().toLowerCase() === (subcategoryCategorySelect.value || "").trim().toLowerCase())?.image ||
          defaultImage;
      });

      changeSubcategoryPhotoBtn.addEventListener("click", () => {
        subcategoryPhotoInput.click();
      });

      subcategoryPhotoInput.addEventListener("change", (e) => {
        const file = e.target.files[0];
        if (file) {
          // Check file size to prevent bloat (limit 500KB)
          if (file.size > 500 * 1024) {
            alert("Image too large! Use a smaller image to avoid storage issues.");
            subcategoryImg.src = defaultImage;
            return;
          }
          const reader = new FileReader();
          reader.onload = (event) => {
            subcategoryImg.src = event.target.result;
          };
          reader.readAsDataURL(file);
        }
      });

      // Enhanced form submission with validation and storage checks
      subcategoryForm.addEventListener("submit", (e) => {
        e.preventDefault();
        console.log("Save button clicked. Form data:", {
          category: subcategoryCategorySelect.value,
          subcategory: subcategoryNameInput.value,
          productName: productNameInput.value,
          price: priceInput.value,
          quantity: quantityInput.value,
          desc: subcategoryDescInput.value,
          image: subcategoryImg.src,
          editingIndex: editingIndex
        });
        try {
          if (!subcategoryCategorySelect.value || !subcategoryNameInput.value || !productNameInput.value || !priceInput.value || !quantityInput.value || !subcategoryDescInput.value) {
            console.error("Validation failed: Some fields are empty or invalid.");
            alert("Please fill all fields.");
            return;
          }
          const priceValue = parseFloat(priceInput.value);
          const quantityValue = parseInt(quantityInput.value);
          if (isNaN(priceValue) || isNaN(quantityValue)) {
            console.error("Validation failed: Price or quantity is not a number.");
            alert("Price and quantity must be valid numbers.");
            return;
          }
          let imageSrc = subcategoryImg.src;
          // Prevent bloat: If image is base64 and too long, fallback to default
          if (imageSrc.startsWith('data:') && imageSrc.length > 1000000) { // ~1MB threshold
            console.warn("Image too large for storage, using default.");
            imageSrc = defaultImage;
          }
          const subcategory = {
            category: subcategoryCategorySelect.value,
            subcategory: subcategoryNameInput.value,
            productName: productNameInput.value,
            price: priceValue,
            quantity: quantityValue,
            desc: subcategoryDescInput.value,
            image: imageSrc,
            createdAt: editingIndex >= 0 ? subcategories[editingIndex].createdAt || new Date().toISOString() : new Date().toISOString()
          };
          if (editingIndex >= 0) {
            subcategories[editingIndex] = subcategory;
          } else {
            subcategories.push(subcategory);
          }
          console.log("Saving to localStorage:", subcategory);
          // Check storage quota before saving
          if (JSON.stringify(subcategories).length > 5 * 1024 * 1024) { // ~5MB check
            throw new Error("Storage quota exceeded - too many/large images. Clear storage and try again.");
          }
          localStorage.setItem("subcategories", JSON.stringify(subcategories));
          console.log("Subcategories after save:", subcategories);
          // Reset filters to show new item
          searchInput.value = "";
          categorySelect.value = "all";
          renderSubcategories("", "all");
          subcategoryPopup.style.display = "none";
          if (editingIndex === -1) {
            const uniqueCategories = deduplicateCategories(categories);
            subcategoryCategorySelect.value = uniqueCategories[0]?.name.trim().toLowerCase() || "";
            subcategoryNameInput.value = "";
            productNameInput.value = "";
            priceInput.value = "";
            quantityInput.value = "";
            subcategoryDescInput.value = "";
            subcategoryImg.src =
              uniqueCategories.find((cat) => (cat.name || "").trim().toLowerCase() === (subcategoryCategorySelect.value || "").trim().toLowerCase())?.image ||
              defaultImage;
          } else {
            const sub = subcategories[editingIndex];
            subcategoryCategorySelect.value = sub.category;
            subcategoryNameInput.value = sub.subcategory;
            productNameInput.value = sub.productName;
            priceInput.value = sub.price;
            quantityInput.value = sub.quantity;
            subcategoryDescInput.value = sub.desc;
            subcategoryImg.src = sub.image || defaultImage;
          }
        } catch (error) {
          console.error("Error during form submission:", error.name, error.message);
          alert(`An error occurred while saving: ${error.message}. Check the console for details. (Likely storage quota - try smaller images or reset storage.)`);
        }
      });

      document.querySelectorAll(".cancel-btn").forEach((btn) => {
        btn.addEventListener("click", () => {
          subcategoryPopup.style.display = "none";
          profilePopup.style.display = "none";
          if (editingIndex >= 0) {
            const sub = subcategories[editingIndex];
            subcategoryCategorySelect.value = sub.category;
            subcategoryNameInput.value = sub.subcategory;
            productNameInput.value = sub.productName;
            priceInput.value = sub.price;
            quantityInput.value = sub.quantity;
            subcategoryDescInput.value = sub.desc;
            subcategoryImg.src = sub.image || defaultImage;
          } else {
            const uniqueCategories = deduplicateCategories(categories);
            subcategoryCategorySelect.value = uniqueCategories[0]?.name.trim().toLowerCase() || "";
            subcategoryNameInput.value = "";
            productNameInput.value = "";
            priceInput.value = "";
            quantityInput.value = "";
            subcategoryDescInput.value = "";
            subcategoryImg.src =
              uniqueCategories.find((cat) => (cat.name || "").trim().toLowerCase() === (subcategoryCategorySelect.value || "").trim().toLowerCase())?.image ||
              defaultImage;
          }
        });
      });

      closePopupBtn.addEventListener("click", () => {
        subcategoryPopup.style.display = "none";
        if (editingIndex >= 0) {
          const sub = subcategories[editingIndex];
          subcategoryCategorySelect.value = sub.category;
          subcategoryNameInput.value = sub.subcategory;
          productNameInput.value = sub.productName;
          priceInput.value = sub.price;
          quantityInput.value = sub.quantity;
          subcategoryDescInput.value = sub.desc;
          subcategoryImg.src = sub.image || defaultImage;
        } else {
          const uniqueCategories = deduplicateCategories(categories);
          subcategoryCategorySelect.value = uniqueCategories[0]?.name.trim().toLowerCase() || "";
          subcategoryNameInput.value = "";
          productNameInput.value = "";
          priceInput.value = "";
          quantityInput.value = "";
          subcategoryDescInput.value = "";
          subcategoryImg.src =
            uniqueCategories.find((cat) => (cat.name || "").trim().toLowerCase() === (subcategoryCategorySelect.value || "").trim().toLowerCase())?.image ||
            defaultImage;
        }
      });

      subcategoryTableBody.addEventListener("click", (e) => {
        if (e.target.classList.contains("edit-subcategory")) {
          editingIndex = parseInt(e.target.getAttribute("data-index"));
          const sub = subcategories[editingIndex];
          popupTitle.textContent = "Edit Subcategory";
          subcategoryCategorySelect.value = (sub.category || "").trim().toLowerCase();
          subcategoryNameInput.value = sub.subcategory;
          productNameInput.value = sub.productName;
          priceInput.value = sub.price;
          quantityInput.value = sub.quantity;
          subcategoryDescInput.value = sub.desc;
          subcategoryImg.src = sub.image || defaultImage;
          subcategoryPopup.style.display = "flex";
        } else if (e.target.classList.contains("delete-subcategory")) {
          const index = parseInt(e.target.getAttribute("data-index"));
          if (confirm("Are you sure you want to delete this subcategory?")) {
            subcategories.splice(index, 1);
            localStorage.setItem("subcategories", JSON.stringify(subcategories));
            renderSubcategories(searchInput.value, categorySelect.value);
          }
        }
      });

      searchInput.addEventListener("input", (e) => {
        renderSubcategories(e.target.value, categorySelect.value);
      });

      sortSelect.addEventListener("change", () => {
        renderSubcategories(searchInput.value, categorySelect.value);
      });

      applyFiltersBtn.addEventListener("click", () => {
        console.log("Applying filters with category:", categorySelect.value);
        renderSubcategories(searchInput.value, categorySelect.value);
      });

      // Reset Storage Button Handler
      resetStorageBtn.addEventListener("click", () =>
